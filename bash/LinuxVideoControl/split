#!/bin/sh

## Скрипт выполняет слияние всех видеофайлов в каталоге за прошедший час.

# Version 1.0

# Подключаем общую для всех скриптов библиотеку функций.
. ./functions

#
# Первичные процедуры - создание файла блокировки, запись в лог файл о начале выполнения.
#

lock_on
log_msg "Запущен"

#####

# Основная программа.

# Ищем все каталоги по шаблону, убирая из вывода выходные файлы и файлы текущего часа во временный файл.
find $camshare -type d | awk {'FS="/"} {print"/"$2"/"$3"/"$4"/"$5"/"$6"/"$7"/"$8}' | grep -v '/$' | grep -v '$outfiles' | grep -v $currentdate > $camshare$tmpfile

# Переходим в найденный каталог, где сортируем файлы, выполняем их слияние и удаляем исходный файл.
for i in `cat $camshare$tmpfile` ; do cd $i ; [ -f $i.avi ] || avimerge -i `ls | sort` -o $i.avi ; rm -fr $i ; done

#####

# 
# Окончательные процедуры - удаление временного файла, запись в лог-файл, удаление файла блокировки.
#

clear_tmp
log_msg "Завершен"
lock_off
